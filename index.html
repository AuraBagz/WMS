<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WaterSlayer - Watermark Removal</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div class="app">
        <!-- Header -->
        <header class="header">
            <div class="header-brand">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="brand-icon">
                    <path
                        d="M12.378 1.602a.75.75 0 00-.756 0L3 6.632l9 5.25 9-5.25-8.622-5.03zM21.75 7.93l-9 5.25v9l8.628-5.032a.75.75 0 00.372-.648V7.93zM11.25 22.18v-9l-9-5.25v8.57a.75.75 0 00.372.648l8.628 5.033z" />
                </svg>
                <h1>WaterSlayer</h1>
            </div>
            <div class="header-status">
                <span class="status-dot" id="status-dot"></span>
                <span id="status-text">Connecting...</span>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main">
            <!-- Left Panel: Controls -->
            <aside class="sidebar">
                <!-- Model Selection -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                            </svg>
                            Detection Model
                        </h3>
                    </div>
                    <div class="card-body">
                        <select id="model-select" class="select">
                            <option value="">Select a model...</option>
                        </select>

                        <!-- Loaded Model Status -->
                        <div id="loaded-model-status" class="model-status">
                            <span class="model-status-dot"></span>
                            <span id="loaded-model-name">No model loaded</span>
                        </div>

                        <div class="btn-group" style="margin-top: 12px;">
                            <button class="btn btn-primary btn-sm" id="load-model-btn" disabled>
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor" width="16" height="16">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg>
                                Load Model
                            </button>
                            <button class="btn btn-ghost btn-sm" id="refresh-models-btn">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor" width="16" height="16">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                </svg>
                            </button>
                            <button class="btn btn-ghost btn-sm" id="import-model-btn">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor" width="16" height="16">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                                </svg>
                            </button>
                        </div>
                        <p class="help-text" style="margin-top: 8px;">Load model into GPU for faster processing</p>
                    </div>
                </div>

                <!-- Video Selection -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                            </svg>
                            Input Video
                        </h3>
                    </div>
                    <div class="card-body">
                        <!-- Browse from anywhere -->
                        <div class="file-input-wrapper">
                            <input type="file" id="video-file-input" accept="video/*" class="hidden">
                            <button class="btn btn-primary w-full" id="browse-video-btn">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor" width="16" height="16">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M5 19a2 2 0 01-2-2V7a2 2 0 012-2h4l2 2h4a2 2 0 012 2v1M5 19h14a2 2 0 002-2v-5a2 2 0 00-2-2H9a2 2 0 00-2 2v5a2 2 0 01-2 2z" />
                                </svg>
                                Browse Video File...
                            </button>
                        </div>

                        <!-- Selected file info -->
                        <div id="selected-video-info" class="selected-file-info hidden">
                            <div class="file-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                                </svg>
                            </div>
                            <div class="file-details">
                                <div class="file-name" id="selected-video-name">No file selected</div>
                                <div class="file-meta" id="selected-video-meta"></div>
                            </div>
                            <button class="btn btn-ghost btn-sm" id="clear-video-btn" title="Clear">Ã—</button>
                        </div>

                        <!-- Or select from input folder -->
                        <div class="divider">
                            <span>or select from server folders</span>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Server Source</label>
                            <select id="video-source-select" class="select">
                                <option value="input">Input Folder (data/input)</option>
                                <option value="output">Output Folder (data/output)</option>
                                <option value="all">Input + Output</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Subfolder (optional)</label>
                            <input id="video-subdir-input" class="select" type="text" placeholder="Example: Watermark_Clips_20260225">
                        </div>

                        <select id="video-select" class="select">
                            <option value="">Select from server...</option>
                        </select>

                        <button class="btn btn-ghost btn-sm" id="refresh-videos-btn" style="margin-top: 8px;">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor" width="16" height="16">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                            </svg>
                            Refresh
                        </button>
                    </div>
                </div>

                <!-- Settings -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                            Settings
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">High Confidence Threshold</label>
                            <div class="slider-container">
                                <input type="range" id="conf-slider" min="10" max="95" value="50" class="slider">
                                <span id="conf-display" class="slider-value">50%</span>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Low Confidence Threshold</label>
                            <div class="slider-container">
                                <input type="range" id="low-conf-slider" min="5" max="80" value="20" class="slider">
                                <span id="low-conf-display" class="slider-value">20%</span>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Inpainting Method</label>
                            <select id="method-select" class="select">
                                <option value="auto">Auto (Best Available)</option>
                                <option value="opencv">OpenCV (Fast)</option>
                                <option value="propainter">ProPainter (Quality)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Detection Mode</label>
                            <select id="detection-mode-select" class="select">
                                <option value="strict_parity">Strict Parity (AnnoStudio)</option>
                                <option value="standard">Standard (Smoothed)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Quality Profile</label>
                            <select id="quality-select" class="select">
                                <option value="auto">Auto (Detect GPU)</option>
                                <option value="balanced">Balanced</option>
                                <option value="rtx5090">RTX 5090 (Maximum Quality)</option>
                                <option value="rtx5090_crisp">RTX 5090 (Crisp Removal)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Detail Restore Pass</label>
                            <select id="detail-restore-select" class="select">
                                <option value="off">Off</option>
                                <option value="roi_sharpen">ROI Sharpen (Recommended)</option>
                                <option value="roi_sharpen_strong">ROI Sharpen (Strong)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Detection Source -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
                            </svg>
                            Detection Source
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="toggle-group">
                            <button class="toggle-btn active" id="toggle-yolo" data-mode="yolo">YOLO Model</button>
                            <button class="toggle-btn" id="toggle-manual" data-mode="manual">Manual Box</button>
                        </div>

                        <!-- Manual box controls (hidden by default) -->
                        <div id="manual-box-section" class="hidden" style="margin-top: 12px;">
                            <button class="btn btn-primary w-full" id="open-box-modal-btn">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor" width="16" height="16">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
                                </svg>
                                Select Region to Remove
                            </button>
                            <div id="box-coords" class="box-coords hidden">
                                <span id="box-coords-text"></span>
                                <button class="btn btn-ghost btn-sm" id="clear-box-btn">Clear</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Process Button -->
                <button class="btn btn-primary btn-lg w-full" id="process-btn" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                    Remove Watermarks
                </button>
            </aside>

            <!-- Center: Preview & Progress -->
            <section class="content">
                <!-- Status Card -->
                <div class="card" id="status-card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            Processing Status
                        </h3>
                        <button class="btn btn-danger btn-sm hidden" id="cancel-btn">Cancel</button>
                    </div>
                    <div class="card-body">
                        <div id="status-content" class="status-idle">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor" class="status-icon">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                            </svg>
                            <p>Select a model and video to begin</p>
                        </div>

                        <!-- Progress (hidden initially) -->
                        <div id="progress-section" class="hidden">
                            <div class="progress-info">
                                <span id="stage-text">Detecting watermarks...</span>
                                <span id="progress-percent">0%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                            </div>
                            <div class="stats-row">
                                <div class="stat">
                                    <span class="stat-value" id="stat-frames">0</span>
                                    <span class="stat-label">Frames</span>
                                </div>
                                <div class="stat">
                                    <span class="stat-value" id="stat-watermarks">0</span>
                                    <span class="stat-label">Watermarks</span>
                                </div>
                                <div class="stat">
                                    <span class="stat-value" id="stat-eta">--</span>
                                    <span class="stat-label">ETA</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Output Videos -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                            </svg>
                            Processed Videos
                        </h3>
                        <button class="btn btn-ghost btn-sm" id="refresh-outputs-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor" width="16" height="16">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                            </svg>
                        </button>
                    </div>
                    <div class="card-body" id="outputs-list">
                        <p class="empty-state">No processed videos yet</p>
                    </div>
                </div>
            </section>

            <!-- Right Panel: System Info -->
            <aside class="sidebar sidebar-right">
                <!-- GPU Info -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z" />
                            </svg>
                            System
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="info-row">
                            <span class="info-label">GPU</span>
                            <span class="info-value" id="gpu-name">Loading...</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">CUDA</span>
                            <span class="info-value" id="cuda-status">Loading...</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">PyTorch</span>
                            <span class="info-value" id="pytorch-version">Loading...</span>
                        </div>
                    </div>
                </div>

                <!-- Quick Help -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            Quick Start
                        </h3>
                    </div>
                    <div class="card-body help-content">
                        <ol>
                            <li>Import a trained model from AnnoStudio</li>
                            <li>Place videos in <code>data/input/</code></li>
                            <li>Select model and video</li>
                            <li>Click "Remove Watermarks"</li>
                            <li>Download processed video</li>
                        </ol>
                    </div>
                </div>
            </aside>
        </main>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="20"
            height="20">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
        </svg>
        <span id="toast-message">Success!</span>
    </div>

    <!-- Manual Box Modal -->
    <div class="modal-overlay hidden" id="box-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Select Region to Remove</h2>
                <div class="modal-header-actions">
                    <button class="btn btn-ghost btn-sm" id="modal-cancel-btn">Cancel</button>
                    <button class="btn btn-primary btn-sm" id="modal-confirm-btn" disabled>Confirm Selection</button>
                </div>
            </div>
            <div class="modal-body">
                <div class="modal-canvas-wrap" id="modal-canvas-wrap">
                    <canvas id="box-canvas"></canvas>
                </div>
            </div>
            <div class="modal-footer">
                <div class="frame-scrubber">
                    <label class="form-label" style="margin: 0; font-size: 0.8rem;">Frame</label>
                    <input type="range" id="frame-scrubber" min="0" max="100" value="0" class="slider" style="flex: 1;">
                    <span id="frame-number" class="slider-value" style="min-width: 60px; text-align: right;">0 / 0</span>
                </div>
                <p class="help-text" style="margin-top: 6px;">Click and drag to draw a box. Scrub the slider to check different frames.</p>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
</body>

</html>
